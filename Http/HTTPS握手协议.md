# HTTPS 握手协议 - TLS 握手流程

![HTTPS握手流程](/images/HTTPS握手流程.jpeg)

1. Client-hello 阶段

> 浏览器中完成地址输入后，解析域名获得 IP Host 地址，浏览器会与此 IP Host 的 443 端口(默认，也可以指定其他端口号)尝试连接

> 浏览器会将 `"支持的加密组件"`、`"尝试连接到 Host 头"` 等信息发送给服务器，同时附带上一份随机生成的 `session ticket1`

2. Server-hello 阶段

> 服务器接收到浏览器发送来的 TLS 握手请求后，存储浏览器发送的 `session ticket1`, 然后根据发送来的 host 寻找对应的服务器证书，然后会将`服务器证书`、`服务器与浏览器协商(均支持)的加密套件方法`、`服务器生成的 session ticket2`返回给浏览器

3. Cipher-spec 阶段

> 浏览器收到服务器返回的证书后，会验证证书的有效性。

验证证书有效性步骤

1. 验证证书有效期（起止时间）
2. 验证证书域名（与浏览器地址栏中域名是否匹配）
3. 验证证书吊销状态（CRL+OCSP）
4. 验证证书颁发机构。如果颁发机构是中间证书，再验证中间证书的`有效期/颁发机构/吊销状态`，一直验证到最后一层证书，如果最后一层证书是在操作系统或浏览器内置的，那么就是可信的，否则就是自签名

以上验证步骤，需要全部通过，否则会显示警告

> 若检查通过，浏览器会随机生成一份 `session ticket3`（这是浏览器生成的第二份 ticket），通过返回证书中的公钥，用协商的`秘钥交换算法`加密，返回给服务器。同时，浏览器用 `session ticket1(浏)`、`session ticket2(服)`、`session ticket3(浏)`组合成 `session key`

> 服务器收到 Ciper-spec 后，用配置的私钥，解密出`session ticket3`，用 `session ticket1(浏)`、`session ticket2(服)`、`session ticket3(浏)`组合成 `session key`,（`session ticket1`、`session ticket2`可以被抓包，但是`session ticket3`无法被窃听）

4. 内容传输阶段

> 经历以上步骤，TLS 连接建立完成，在连接销毁前，浏览器与服务器彼此数据均通过 `session key`来进行对称加密

> 由于非对称加密非常消耗 CPU，所以只有在协商秘钥的时候使用非对称加密，而在应用层数据传输时，使用对称加密传输（服务器响应的加密返回，浏览器提交的也加密提交）

## 证书吊销检查

目前写进国际标准的吊销状态检查协议有两种 `1. CRL 2. OCSP`

1. CRL

> 是一份全量的文件，记录了被此 CRL 限制的证书中所有被吊销证书的序列号。通过匹配当前证书序列号，与 CRL 中序列号来判断

1. 所有打上了这个 URL 的 CRL 的证书，只要其中一个被吊销，那么下次 CRL 更新时，均会查询匹配到
2. 那么可不可以认为一个中间颁发机构颁发的证书的 CRL 列表只有一个？

   1. 不可以！因为数量可能太多，厂商完全可以将同一个中间证书颁发的证书，分不同批打不同的 CRL。

3. OCSP

> OCSP 是 TCP 服务，通过请求证书序列号，服务器告知当前序列号是否被吊销名单，

> 有的证书内置了 CRL+OCSP，还有的早期证书只内置了 CRL ，而只内置 CRL 的证书是不被新型浏览器信任了

# 提问

## 吊销状态检查是同步还是异步

> 是同步检查，如果是异步检查，有可能会导致浏览器发送数据给了未验证的服务器后，过了一段时间才检查出来证书已经被吊销，所以必须是同步的

## HTTPS 是否会拖慢性能？

> 浏览器在加密 `session ticket3`和服务器在接收浏览器返回的 `session ticket3`时，是非对称加密中可能出现耗时的步骤，但是这个步骤耗时也不会太长，顶多几毫秒，是可以忽略不计的

> 真正比较耗时，拖慢性能的，是在`证书吊销检查步骤`

> > 由于`证书吊销检查`是同步执行的，会受到 CA 厂商的部署限制，CA 厂商极有可能将 CRL 和 OCSP 服务部署在遥远的小机房，受到了`带宽和链路`的影响

## 怎么规避证书吊销检查带来的性能损耗?

1. 踩上大厂的顺风车
2. 购买国内的 CA 证书

## 为什么 `session ticket3`无法被窃听?

> 有个 webtrust 组织，专门负责备案世界上各国商业与政府官方 CA 机构的公钥证书。如果审计通过，其他浏览器及操作系统/客户端才允许加入新人列表。否则是不允许加入的。如果中间人拦截了 `session ticket3`的响应密文，没有私钥，中间攻击人是解密不了的。而要想拿到私钥，中间人可以做到，就是在客户端和服务器中间搭建代理，替换掉 SSL 证书，以实现服务器返回证书时候中间替换掉自己的，从而在中间拦截服务器呵客户端两头的通信

> 但是这样做，浏览器和客户端会显示非信任的颁发者，

![非信任的颁发者-chrome](/images/非信任的颁发者-chrome.jpeg)

## 参考

- [HTTPS 入门, 图解 SSL 从回车到握手](https://zhuanlan.zhihu.com/p/25587986)
