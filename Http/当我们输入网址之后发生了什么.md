# 当我们输入网址之后发生了什么

## 流程

1. 输入地址(URL 解析)
2. 浏览器查找域名的 IP 地址(DNS 查询)
3. 建立TCP连接
4. 浏览器向 WEB 服务器发送一个 HTTP 请求
5. 服务器处理请求
6. 服务器返回一个 HTTP 响应
7. 浏览器渲染页面(渲染)
8. 浏览器发送请求获取页面中使用到的资源 (如 图片、视频、音频、css、js 等等资源)

## 1. 输入地址(URL 解析)- www.baidu.com

1. 浏览器首先解析你的域名，从而确定
   1. 协议
   2. 域名
   3. 端口号
   4. 路径
   5. 参数等

2. 当开始在浏览器输入网站时，浏览器就已经开始匹配可能的 URL 。从历史记录、书签等等，找到已经输入的字符串可能对应的 URL,然后智能提示。

## 2. 浏览器查找域名的 IP 地址 (DNS-域名系统 查询)

1. 首先检查浏览器缓存
2. 然后检查操作系统缓存
3. 如果都没有，向本地 DNS 服务器发起请求
4. 本地服务器会首先查询缓存，再向根域名服务器、顶级域名服务器和顶级域名服务器查询
5. 最终得到域名对应的 IP

> 1. 请求一旦发起，浏览器首先就是解析域名，浏览器会首先查看本地硬盘的 host 文件，查找是否存在和这个域名对应的规则。如果有,就直接使用 host 文件中的 IP 地址

> 2. 如果在本地 host 文件中没有对应的 IP 地址，浏览器会发出一个 DNS 请求到本地 DNS 服务器(一般都是你的网络接入服务器服务商提供)

> 3. DNS 请求到达本地 DNS 服务器后，本地 DNS 服务器会首先查询缓存，如果缓存中存在这条记录，直接返回结果(此过程是递归的方式进行查询)。如果没有，则本地 DNS 服务器继续向 DNS 根服务器进行查询

> 4. 本地 DNS 服务器获取根 DNS 服务器地址后，继续向根服务器请求，根服务器没有记录具体的域名和 IP 地址的对应关系，而是告诉本地 DNS 服务器，你可以到域服务器上进行查询，并返回域服务器的地址，(这种过程是迭代的过程)

> 5. 获取域服务器地址后，继续向域服务器请求。这个例子中，请求的是 .com 的域服务器。域服务器接收到请求后，也不会返回域名和 IP 地址的对应关系，而是返回当前域名的解析服务器地址

> 6. 最后，获取到域名解析服务器地址后，本地 DNS 服务器向域名的解析服务器请求，这时就能收到一个域名和 IP 地址的对应关系，本地 DNS 服务器将 IP 地址返回给用户电脑，同时将这个对应关系缓存起来，以便下一次用户访问时，可以直接返回结果，加快网络访问

![DNS解析流程](/images/DNS解析流程.jpeg)

## 3. 建立 TCP 链接

1. 进行3次握手
2. 如果是 `HTTPS` 请求，还会进行 `TLS/SSL` 建立加密通道 

## 4. 浏览器向 WEB 服务器发送一个 HTTP 请求

> 拿到网址对应的 IP 地址后，浏览器向服务器的 WEB 程序发起一个 TCP 连接请求。


## 5. 服务器处理请求

> 服务器在接收到 TCP 报文开始，它会对 TCP 连接进行处理，对 HTTP 协议进行解析，并按照报文格式进一步封装成 HTTP Request 对象，供上层使用

> 而一些大一点的网站会将你的请求到反向代理服务器中。当网站访问量非常大时，网站越来越慢，一台服务器已经不够用了。于是将同一个应用部署在多个服务器上，将大量用户的请求分配给多台服务器进行处理。

> 此时客户端不是通过 HTTP 协议访问某网站应用服务器，而是先请求 Nginx ，Nginx 再请求应用服务器，然后在返回给客户端，在这里 Nginx 就是作为反向代理服务器。同时，这里还带来一个好处，那就是如果其中一台服务器挂了，只要还有其他服务器正常使用，那么用户就能够正常访问，不受影响

![Nginx反向代理图](/images/Nginx反向代理图.jpeg)

## 6. 服务器返回一个 HTTP 响应

> 经过前面几个步骤，服务器收到了我们的请求，处理了我们的请求，同时返回一个 HTTP 响应

> HTTP 响应由三部分组成

   1. 状态行
   2. 响应头
   3. 响应正文

## 7. 浏览器显示 HTML

> 浏览器通过 `解析 HTML 构建 DOM 树 -> 解析 CSS 构建 CSSOM 树 -> 通过 DOM 树 CSSOM 树，构建出 Render 树 -> 布局 Render 树 Layout -> 渲染 Render 树 Paint`

   1. 浏览器在解析 HTML 文件时，会`自上而下`的加载，并在加载过程中进行解析渲染。在解析过程中，如果遇到请求外部资源时，如图片、外联 CSS 、iconfont 等等，会进行异步请求，并不会影响 HTML 的解析
   2. 在遇到 style 文件时
      1. `同步下载 css 文件，并解析 css 样式`
   3. 在解析时，遇到 js 文件时，`js 会阻塞 HTML和 CSS 解析`
      1. 默认情况 `同步下载，并解析 js` HTML 的解析会被挂起，等到 js 文件被加载、解析完成后，才会恢复 HTML 文档的解析，因为 js 可能会修改 DOM (document.write)。所以在日常开发中，js 会放在 HTML 文档的末尾
      2. 当 script 具有 defer 属性时，js 文件会异步下载，当 HTML DOM 解析完成后，立即执行 js 代码，`多个带有 defer 属性的script 按照顺序执行`
      3. 当 script 具有 async 属性时，js 文件会异步下载，js 下载完成后，立即执行 js 代码，js 代码解析完成后，再继续 HTML DOM的解析,`多个带有 async 属性的 script 无法保证加载顺序`
      4. defer 是 HTML4 属性，async 是 HTML5 属性，async 的优先级大于 defer
   4. JS 的解析是由浏览器中的 JS 解析引擎完成的，而 JS 是单线程的(同一时间内只能做一件事情)。但是由于可能会存在某些任务比较耗时，所以需要一种机制可以先执行后面的任务。这就是`同步任务`和`异步任务`

## 8. 浏览器发送请求获取页面中使用的资源

> 这个步骤可以并列在 `6` 中

## 参考

- [从输入 URL 到页面展示到底发生了什么？看完吊打面试官！](https://zhuanlan.zhihu.com/p/133906695)
- [在浏览器输入 URL 回车之后发生了什么（超详细版）-前端角度](https://zhuanlan.zhihu.com/p/80551769)
