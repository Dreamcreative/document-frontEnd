# HTTP 握手协议

## TCP 三次握手

> 第一次握手：建立连接时，客户端发送 SYN (syn=j)包到服务器，并进入 SYN_SENT 状态，等待服务器确认；

    1. SYN ：同步序列编号

> 第二次握手： 服务器接收到 SYN 包，必须确认客户端的 SYN (ack=j+1),同时自己也发送一个 SYN (syn = k)包，即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态；

> 第三次握手： 客户端收到服务器的 SYN+ACK 包，向服务器发送确认包 ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED （TCP 连接成功）状态，完成三次握手

> > 完成三次握手后，客户端与服务器开始传送数据。这样就保证了每次传送数据都会准确达到目标设备

### 为什么要三次握手

> 三次握手的目的是为了建立可靠的通信信道，为了双方确认自己与对方的发送与接收是正常的

只有经过三次握手才能确认双方的收发功能是正常的，缺一不可

    1. 第一握手(客户端发送 SYN 报文给服务器，服务器接收报文)：
    	- 客户端可以什么都不能确认，
    	- 服务器确认了对方发送正常，自己接收正常
    2. 第二次握手(服务器响应客户端的 SYN 报文，客户端接收到服务器的 SNY+ACK 报文)：
    	- 客户端确认了自己发送、接收正常，服务器发送、接收正常；
    	- 服务器确认了自己接收正常，客户端发送正常
    3. 第三次握手(客户端发送 ACK 报文给服务)：
    	- 客户端确认了自己发送、接收正常，服务器发送、接收正常；
    	- 服务器确认了自己发送、接收正常，客户端发送、接收正常

### 三次握手中可以携带数据吗

> 第三次握手的时候可以携带数据，但是第一次、第二次握手绝对不能携带数据

假如第一次握手可以携带数据，如果有人恶意攻击服务器，那他每次都在第一次握手中的 SYN 报文中放入大量数据(根本不需要管服务是否发送、接收正常)，服务器就得花费大量的时间和内存来接收这些报文

### 半连接队列

> 服务器第一次接收到客户端的 SYN 之后，会处于 SYN_RECV 状态，此时双方还没有完全建立连接，服务器会把这种状态的请求连接放在一个队列里 -- 半连接队列

### 如果第三次握手丢失了，客户端、服务器会如何处理

> 服务器在发送完 SYN_ACK 报文后，如果未接收到客户端响应的确认包，也就是第三次握手丢失。服务器会按照设置的最大重连数，进行首次重传，如果重传已经超过了设置的最大重连数，服务器会将该连接从半连接队列中删除

## TCP 四次挥手

> 当数据包发送完毕后，需要断开连接的时候，就需要 TCP 的四次挥手来保证连接的合理断开

> 第一次挥手： 客户端向服务器发送断开连接指令 FIN 报文，报文会指定一个序列号 seq=u。并停止发送数据，主动关闭连接。此时客户端处于 FIN_WAIT_1 状态，等待服务器确认

    1. FIN_WAIt_1：等待远程 TCP 的连接中断请求，或先前的连接中断请求的确认

> 第二次挥手：服务器接收到 FIN 之后，会发送 ACK 报文，且把客户端的序列号 req+1 作为 ACK 的序列号，表面已经接收到客户端的报文了，此时服务器处于 CLOSE_WAIT 状态

    1. CLOSE_WAIT：等待本地用户发来的连接中断请求

> > 此时的 TCP 处于半关闭状态，客户端到服务器的连接释放。客户端收到服务器端的确认后，客户端进入 FIN_WAIT_2 (终止等待 2)状态，等待服务器发送的连接释放报文段

    1. FIN_WAIT_2： 从远端 TCP 等待连接中断请求

> 第三次挥手： 如果服务器也想断开连接了(没有要向客户端发送的数据)，和客户端第一次挥手一样，想客户端发送 FIN 报文，且指定一个序列号。此时服务器处于 LAST_ACK 状态，等待客户端的确认

    1. LAST_ACK： 等待原来发向远程 TCP 的连接中断请求的确认

> 第四次挥手：客户端接收到 FIN 报文后，一样发送一个 ACK 报文作为应答 (ack=w+1)，且把服务器的序列号+1 作为自己 ACK 报文的序列号(seq=u+1),此时客户端处于 TIME_WAIT(时间等待)状态

    1. TIME_WAIT： 等待足够的时间以确保远程 TCP 接收到连接中断请求的确认

> > 注意：这时服务器向客户端的 TCP 连接并未释放掉，需要经过等待计时器设置的时间 2MSL (一个报文的来回时间)后才会进入 CLOSED 状态。这样做的目的是确保服务器收到自己的 ACK 报文，如果服务器在规定时间内没有收到客户端发来的 ACK 报文的话， 服务器会重新发送 FIN 报文给客户端，客户端再次收到服务器的 FIN 报文后，就知道之前的 ACK 报文丢失，然后再次发送 ACK 报文给服务器。服务器接收到 ACK 报文后，就关闭连接，处于 CLOSED 状态。

### 为什么要四次挥手

> 任何一方都可以在数据传送结束后发出连接释放的通知。通俗来讲，两次挥手就能断开一方的 TCP 连接，所以完全断开双方的 TCP 连接需要四次

## 参考

- [http 请求之面试常问的 tcp 三次握手和 tcp 四次挥手](https://www.jianshu.com/p/23c76a127e2d)

- [关于 TCP 三次握手和四次挥手，满分回答在此](https://segmentfault.com/a/1190000039165592)
