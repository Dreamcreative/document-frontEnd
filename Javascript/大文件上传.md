# 前端实现大文件上传

## 前端的上传方式

1. 使用 form 表单上传
2. 将文件解析为 base64 进行上传，存在两个问题

3. 文件比较大，转为 base64 耗时较长
4. 文件转为 base64 后，生成的 base64 会比原文件大

5. 使用 formData 上传

```js
var file = e.target.files;
var formData = new FormData();
formData.append('file', file);
axios.post(url, formData);
```

## 大文件上传

1. 分片上传

   - 文件 File 对象是 Blob 对象的子类，Blob 对象具有一个 slice 方法，可以将文件进行拆分
   - 将文件按照一个给定的大小进行切分，然后将切分后的数据进行批量上传

> 这里会有两个问题，1. 就是服务器怎么知道分片上传的文件是属于同一个文件的，2. 上传完毕后，服务器按照什么顺序进行文件合并

- 服务器怎么知道上传的文件是属于同一个文件的

  - 根据文件名或者文件的其他信息生成一段文件信息，在分片上传时一同发送给服务器
  - 或者是根据文件内容生成一段 md5 编码，但是大文件的 md5 生成比较耗时

- 上传完毕后，服务器按什么顺序进行文件合并

  - 上传时，将文件分片后的序号同时发送给服务器。而服务器在接收到上传完成时，按照上传时添加的顺序进行合并

2. 断点续传

- 如果在上传文件时，已经上传了一部分，但是由于断网、页面刷新等情况，导致上传失败。这时就需要文件的断点续传功能，对已上传的文件分片不再上传，直接上传未上传成功的文件分片。需要解决一个问题，怎么获取已上传部分的内容

  1. 将已上传文件部分信息存储在客户端本地，比如 localstorage。再上传下一个分片时，先从本地获取已上传部分，未上传的部分再进行上传
  2. 通过接口从服务器获取已上传部分的文件信息，在每次上传文件分片时，先进行请求。

3. 上传进度

   1. 通过`xhr.upload`的 progress 方法，获取上传进度

4. 暂停

   1. 需要对文件进行暂停上传时，直接调用 `xhr.abort`方法直接暂停。当下次上传开启时，获取已上传文件部分的信息，直接从未上传部分开始执行上传操作

## 参考

- [前端大文件上传](https://juejin.cn/post/6844903860327186445#heading-2)
