# 如何减少 APP 白屏时间

## 页面打开过程

  1. APP 内打开页面
  2. DNS 解析

    * DNS 预解析
    * 域名收敛

  3. TCP 连接

    * 预连接

  4. 发送请求并响应

    * HTTP2

  5. 浏览器解析页面

    * 服务器渲染

  6. 加载资源并渲染页面

    * 骨架屏
    * 资源优化
    * 资源预加载

  7. 请求接口，获取数据并渲染

    * 接口预加载
    * 接口合并

## DNS 解析优化

> DNS 域名解析，获取 IP 地址，获取到真正的 IP 后，向服务器发送 HTTP 请求

### DNS 预解析

> 通过 DNS 预解析的方式提前获取 IP 地址，

> 前端通过 `dns-prefetch` 添加预解析

```js
<link rel="dns-prefetch" href="https://www.baidu.com"></link>
```

  * 当浏览器请求第三方服务器资源时，必须先将第三方域名地址解析为 IP,然后浏览器才能发出请求，此为 `DNS` 解析。而 DNS 缓存可以减少此延迟。
  * `dns-prefetch`可以帮助开发者掩盖 DNS 解析延迟

    1. `dns-prefetch` 仅对跨域域名的 DNS 查询有效（自己的域名也不需要...）,因此避免它指向自己的站点

### 域名收敛

> 目的是减少页面中域名的数量，从而减少 DNS 查询次数。

## TCP 连接优化

> 前端可以通过`preconnect` 在请求发送前先执行一部分操作，这些操作包括 `DNS解析`、`TCP 握手`、`TLS 协商`

```js
<link rel="preconnect" href="https://www.baidu.com">
```

## 请求优化

> 使用 HTTP2/HTTP3 协议，HTTP2协议新增

  * `二进制分帧层`：使用二进制传输数据，更紧凑
  * `服务器推送`：浏览器发送请求时，浏览器主动分析所需要的资源，同时推送给服务器，
  * `多路复用`：一个 TCP 连接，实现资源并行请求
  * `请求头压缩`：HTTP1.x 只对请求主体进行了压缩

## 页面解析优化

> 浏览器获取 HTML 文件后，需要对 HTML 进行解析，然后才开始渲染页面

### 服务器渲染

> 在服务器中将页面的渲染逻辑处理好，然后将处理好的页面返回给前端，前端直接展示，减少了`普通渲染`的解析时间

### 预渲染

> 在前端打包时使用`prerender-spa-plugin`之类的第三方库，进行简单的预渲染

## 资源加载优化和页面渲染优化

> 浏览器解析 HTML 的同时，会加载相关的资源，通过对资源的加载过程进行优化也可以减少页面的白屏时间

### 骨架屏

> 骨架屏是在需要等待加载内容的位置提供一些图形占位，提前给用户描述页面的基础结构，等待数据加载完成后，在替换为实际的内容

### 静态资源优化

  * 减少资源大小

    1. 启用 gzip 压缩文件
    2. 对大文件资源进行拆分，动态加载

  * 加快资源加载速度

    1. 将静态资源放在 CDN 中
    2. 使用 HTTP2 协议

### 资源预加载

  * prefetch: 指定需要使用的资源，在浏览器空闲时加载资源

```js
<link rel="prefetch" href="https://www.baidu.com/index.js">
```

  * preload:执行提前获取之后需要的资源，浏览器会立即加载对应的资源，在解析到对应资源后，`立即执行`

```js
<link rel="preload" href="https://www.baidu.com/index.js" as="script">
```

  * quicklink:谷歌开源的预加载库，quicklink会判断连接进入视口后，在空闲时预加载。

## 接口请求优化

  * 接口合并：将过多的接口进行接口合并，减少 http 请求数量，减少 TCP 建立的时间

## 参考

* [dns-prefetch](https://developer.mozilla.org/zh-CN/docs/Web/Performance/dns-prefetch)
